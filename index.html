<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MBTA Near">
<title>MBTA Nearby</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0e17;
  --surface: #131a2b;
  --surface-2: #1a2340;
  --border: #243052;
  --text: #e8ecf4;
  --text-dim: #8892a8;
  --text-muted: #556180;
  --accent: #4de8b4;
  --accent-dim: #2a8c6a;
  --danger: #ff6b7a;
  --warning: #ffb84d;
  --bus: #ffd23f;
  --subway: #ff6b35;
  --rail: #a78bfa;
  --ferry: #38bdf8;
  --tram: #4ade80;
  --catchable: #4de8b4;
  --missed: #ff6b7a;
  --tight: #ffb84d;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* --- Header --- */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(10, 14, 23, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 16px 20px 12px;
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.logo {
  font-family: 'DM Mono', monospace;
  font-weight: 500;
  font-size: 15px;
  letter-spacing: 0.08em;
  color: var(--accent);
  text-transform: uppercase;
}

.logo span { color: var(--text-dim); }

.updated {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
}

.header-actions {
  display: flex;
  gap: 8px;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 18px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--surface);
  color: var(--text);
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}

.btn:active { transform: scale(0.97); }
.btn-primary {
  background: var(--accent);
  color: var(--bg);
  border-color: var(--accent);
  flex: 1;
}
.btn-primary:active { background: var(--accent-dim); }

.btn-icon {
  width: 42px;
  padding: 10px;
  justify-content: center;
}

/* --- States --- */
.state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60dvh;
  padding: 40px 20px;
  text-align: center;
}

.state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.7;
}

.state-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
}

.state-desc {
  font-size: 14px;
  color: var(--text-dim);
  max-width: 280px;
  line-height: 1.5;
}

/* Spinner */
@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  width: 36px;
  height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 16px;
}

/* --- Stop cards --- */
.stops-list {
  padding: 12px 12px 100px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.stop-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
  animation: fadeUp 0.35s ease-out both;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

.stop-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  padding: 14px 16px 10px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.stop-name {
  font-size: 15px;
  font-weight: 600;
  line-height: 1.3;
  flex: 1;
  margin-right: 12px;
}

.stop-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.walk-badge {
  display: flex;
  align-items: center;
  gap: 4px;
  font-family: 'DM Mono', monospace;
  font-size: 13px;
  font-weight: 500;
  color: var(--accent);
  background: rgba(77, 232, 180, 0.1);
  padding: 4px 10px;
  border-radius: 8px;
  white-space: nowrap;
}

.walk-badge svg {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.walk-method {
  font-size: 9px;
  color: var(--text-muted);
  font-family: 'DM Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.distance {
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
}

/* Predictions */
.predictions {
  padding: 0 16px 14px;
}

.pred-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-top: 1px solid rgba(36, 48, 82, 0.6);
}

.route-badge {
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 6px;
  white-space: nowrap;
  min-width: 42px;
  text-align: center;
}

.pred-times {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1px;
}

.pred-departs {
  font-size: 13px;
  font-weight: 500;
}

.pred-leave {
  font-size: 11px;
  font-family: 'DM Mono', monospace;
}

.pred-leave.catchable { color: var(--catchable); }
.pred-leave.tight { color: var(--tight); }
.pred-leave.missed { color: var(--missed); }

.pred-status {
  font-size: 11px;
  color: var(--text-muted);
  font-family: 'DM Mono', monospace;
}

.no-predictions {
  padding: 10px 0;
  font-size: 13px;
  color: var(--text-muted);
  font-style: italic;
}

/* Nav link */
.nav-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 6px;
  padding: 6px 12px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-dim);
  font-size: 12px;
  text-decoration: none;
  -webkit-tap-highlight-color: transparent;
}

.nav-link:active { background: var(--border); }

/* Error banner */
.error-banner {
  margin: 12px;
  padding: 14px 16px;
  background: rgba(255, 107, 122, 0.1);
  border: 1px solid rgba(255, 107, 122, 0.3);
  border-radius: 12px;
  color: var(--danger);
  font-size: 14px;
  text-align: center;
}

/* Responsive */
@media (min-width: 500px) {
  .stops-list { max-width: 480px; margin: 0 auto; }
  .header { padding-left: calc(50% - 230px); padding-right: calc(50% - 230px); }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div class="logo">MBTA <span>Nearby</span></div>
    <div class="updated" id="updated-time"></div>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" id="refresh-btn" onclick="refresh()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 019-9 9.75 9.75 0 016.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 01-9 9 9.75 9.75 0 01-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
      Refresh
    </button>
    <button class="btn btn-icon" onclick="openSettings()" title="Settings">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
    </button>
  </div>
</div>

<div id="content">
  <div class="state" id="state-initial">
    <div class="state-icon">üìç</div>
    <div class="state-title">Find what's nearby</div>
    <div class="state-desc">Tap Refresh to get your location and find nearby MBTA stops with real-time departures.</div>
  </div>
</div>

<!-- Settings modal (simple) -->
<div id="settings-overlay" style="display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,0.7); padding:20px; display:none; align-items:center; justify-content:center;">
  <div style="background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:24px; max-width:360px; width:100%;">
    <h3 style="font-size:16px; margin-bottom:16px;">Settings</h3>
    <label style="font-size:13px; color:var(--text-dim); display:block; margin-bottom:6px;">Search radius (miles)</label>
    <select id="radius-select" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--surface-2); color:var(--text); font-size:14px; margin-bottom:20px;">
      <option value="0.005">¬º mile</option>
      <option value="0.01" selected>¬Ω mile</option>
      <option value="0.02">1 mile</option>
      <option value="0.04">2 miles</option>
    </select>
    <button class="btn btn-primary" style="width:100%;" onclick="closeSettings()">Done</button>
  </div>
</div>

<script>
const API = '/api/nearby';
let lastData = null;

function $(id) { return document.getElementById(id); }

function openSettings() {
  const o = $('settings-overlay');
  o.style.display = 'flex';
}
function closeSettings() {
  $('settings-overlay').style.display = 'none';
}

function showLoading() {
  $('content').innerHTML = `
    <div class="state">
      <div class="spinner"></div>
      <div class="state-title">Finding stops‚Ä¶</div>
      <div class="state-desc">Getting your location and fetching nearby MBTA data.</div>
    </div>`;
}

function showError(msg) {
  $('content').innerHTML = `
    <div class="state">
      <div class="state-icon">‚ö†Ô∏è</div>
      <div class="state-title">Something went wrong</div>
      <div class="state-desc">${msg}</div>
    </div>`;
}

function routeColor(pred) {
  if (pred.route_color) return '#' + pred.route_color;
  const type = pred.route_type;
  if (type === 0) return 'var(--tram)';
  if (type === 1) return 'var(--subway)';
  if (type === 2) return 'var(--rail)';
  if (type === 3) return 'var(--bus)';
  if (type === 4) return 'var(--ferry)';
  return 'var(--text-dim)';
}

function routeTextColor(pred) {
  return pred.route_text_color ? '#' + pred.route_text_color : '#000';
}

function typeIcon(type) {
  return {0:'üöä',1:'üöá',2:'üöÜ',3:'üöå',4:'‚õ¥Ô∏è'}[type] || 'üöè';
}

function leaveClass(secs) {
  if (secs === null || secs === undefined) return '';
  if (secs <= 0) return 'missed';
  if (secs < 120) return 'tight';
  return 'catchable';
}

function fmtMin(secs) {
  if (secs === null || secs === undefined) return '‚Äî';
  const m = Math.round(secs / 60);
  if (m <= 0) return 'now';
  return m + ' min';
}

function fmtTime(iso) {
  if (!iso) return '';
  try {
    const d = new Date(iso);
    return d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
  } catch { return ''; }
}

function render(data) {
  lastData = data;
  const now = new Date(data.updated_at);
  $('updated-time').textContent = 'Updated ' + now.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', second:'2-digit'});

  if (!data.stops || data.stops.length === 0) {
    $('content').innerHTML = `
      <div class="state">
        <div class="state-icon">üîç</div>
        <div class="state-title">No stops found</div>
        <div class="state-desc">${data.message || 'Try increasing the search radius in settings.'}</div>
      </div>`;
    return;
  }

  let html = '<div class="stops-list">';
  data.stops.forEach((stop, i) => {
    const walkIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1.5"/><path d="M9 20l3-8 3 8M10.5 14h3M15 8l-3 2-3-2"/></svg>`;
    
    html += `<div class="stop-card" style="animation-delay:${i * 0.05}s">`;
    html += `<div class="stop-header">`;
    html += `<div>
      <div class="stop-name">${stop.name}</div>
      <div class="distance">${stop.distance_m}m away</div>
    </div>`;
    html += `<div style="text-align:right">
      <div class="walk-badge">${walkIcon} ${fmtMin(stop.walk_seconds)}</div>
      <div class="walk-method">${stop.walk_method === 'openrouteservice' ? 'routed' : 'est.'}</div>
    </div>`;
    html += `</div>`; // stop-header

    html += `<div class="predictions">`;
    if (stop.predictions.length === 0) {
      html += `<div class="no-predictions">No real-time predictions available</div>`;
    } else {
      stop.predictions.forEach(p => {
        const bg = routeColor(p);
        const fg = routeTextColor(p);
        const cls = leaveClass(p.leave_in_seconds);
        const depTime = fmtTime(p.departure_time || p.arrival_time);
        
        let leaveLabel = '';
        if (p.catchable === true) {
          leaveLabel = `Leave in ${fmtMin(p.leave_in_seconds)}`;
        } else if (p.catchable === false) {
          leaveLabel = 'Too late';
        } else {
          leaveLabel = '‚Äî';
        }

        html += `<div class="pred-row">
          <div class="route-badge" style="background:${bg};color:${fg}">${p.route_name}</div>
          <div class="pred-times">
            <div class="pred-departs">Departs in ${fmtMin(p.departs_in_seconds)} <span style="color:var(--text-muted);font-size:11px">${depTime}</span></div>
            <div class="pred-leave ${cls}">${leaveLabel}</div>
          </div>
          ${p.status ? `<div class="pred-status">${p.status}</div>` : ''}
        </div>`;
      });
    }

    // Maps link
    if (stop.lat && stop.lon) {
      html += `<a class="nav-link" href="https://maps.apple.com/?daddr=${stop.lat},${stop.lon}&dirflg=w" target="_blank">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11l19-9-9 19-2-8-8-2z"/></svg>
        Walk here
      </a>`;
    }

    html += `</div>`; // predictions
    html += `</div>`; // stop-card
  });
  html += '</div>';
  $('content').innerHTML = html;
}

function refresh() {
  showLoading();
  if (!navigator.geolocation) {
    showError('Geolocation is not supported by your browser.');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const {latitude, longitude} = pos.coords;
      const radius = $('radius-select').value;
      fetch(`${API}?lat=${latitude}&lon=${longitude}&radius=${radius}`)
        .then(r => {
          if (!r.ok) return r.json().then(d => { throw new Error(d.error || 'API error'); });
          return r.json();
        })
        .then(render)
        .catch(e => showError(e.message));
    },
    err => {
      const msgs = {
        1: 'Location permission denied. Please enable location access.',
        2: 'Location unavailable. Check your connection.',
        3: 'Location request timed out. Try again.',
      };
      showError(msgs[err.code] || 'Could not get location.');
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
  );
}
</script>

</body>
</html>
